<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุนูุงุฏุฉ ุงูุจูุทุฑูุฉ ุงูุฐููุฉ - ุชุญููู ุงูุฏุฌุงุฌ ุจุงูููุฏูู</title>
    <meta name="description" content="ูุธุงู ุชุญููู ุดุงูู ููุฏุฌุงุฌ ุนุจุฑ ุงูููุฏูู ุงููุจุงุดุฑ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@latest/dist/teachablemachine-image.min.js"></script>
    <link rel="stylesheet" href="/chicken-disease-site/video-application-2/video-clinic.css">
</head>

<body>

    <header class="header" id="mainHeader">
        <div class="header-fixed-text">ูุฏ ููุงู</div>
        <div class="container">
            <div class="header-content">
                <a href="../index.html" class="logo">
                    <i class="fas fa-stethoscope"></i>
                    <span>ุงูุนูุงุฏุฉ ุงูุจูุทุฑูุฉ ุงูุฐููุฉ</span>
                </a>

                <button class="mobile-menu-toggle" id="mobileMenuToggle" aria-label="ูุชุญ ุงููุงุฆูุฉ">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>

                <nav id="mainNav" class="main-nav">
                    <ul>
                        <li><a href="../index.html" class="nav-link">ุงูุฑุฆูุณูุฉ</a></li>
                        <li><a href="#record" class="nav-link active">ุงูุชุตููุฑ ุงููุจุงุดุฑ</a></li>
                        <li><a href="#results" class="nav-link">ุงููุชุงุฆุฌ</a></li>
                    </ul>
                </nav>

                <div class="auth-buttons">
                    <button class="btn btn-outline" onclick="window.location.href='../index.html'">
                        <i class="fas fa-home"></i>
                        <span>ุงูุฑุฆูุณูุฉ</span>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <section class="hero">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title animate-fade-in">
                    ุชุญููู ุงูุฏุฌุงุฌ
                    <span class="gradient-text">ุจุงูุชุตููุฑ ุงููุจุงุดุฑ</span>
                </h1>
                <p class="hero-description animate-fade-in-delay-1">
                    ูุธุงู ูุชูุงูู ูุนุชูุฏ ุนูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุชุญููู ุญุฑูุฉ ูุณููู ุงูุฏุฌุงุฌ ุนุจุฑ ุงูููุฏูู ุงููุจุงุดุฑ ูุชูุฏูู ุชุดุฎูุต ุฏููู ูุญุงูุชูุง ุงูุตุญูุฉ.
                </p>

                <div class="hero-stats animate-fade-in-delay-2">
                    <div class="stat-item">
                        <div class="stat-number" data-count="4">0</div>
                        <div class="stat-label">ูุฌุงูุงุช ุชุญููู</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" data-count="60">0</div>
                        <div class="stat-label">ุซุงููุฉ ุชุญููู</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" data-count="12">0</div>
                        <div class="stat-label">ูุคุดุฑ ุฃุฏุงุก</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="hero-bg-animation">
            <div class="floating-icon" style="left: 10%; top: 20%; animation-delay: 0s;"><i class="fas fa-walking"></i></div>
            <div class="floating-icon" style="left: 80%; top: 30%; animation-delay: 1s;"><i class="fas fa-running"></i></div>
            <div class="floating-icon" style="left: 20%; top: 70%; animation-delay: 2s;"><i class="fas fa-feather"></i></div>
            <div class="floating-icon" style="left: 75%; top: 75%; animation-delay: 1.5s;"><i class="fas fa-chart-line"></i></div>
        </div>
    </section>

    <main class="main-content" id="record">
        <div class="container">
            <div class="content-wrapper">

                <section class="recording-section" id="recordingSection">
                    <div class="section-title">
                        <h2>ุงูุฎุทูุฉ 1: ุงูุชุตููุฑ ูุงูุชุญููู ุงููุจุงุดุฑ</h2>
                        <p>ูู ุจุชุตููุฑ ุงูุฏุฌุงุฌุฉ ููุจุฏุก ูู ุงูุชุญููู ุงูููุฑู ููุญุฑูุฉ ูุงูุณููู</p>
                    </div>
                    
                    <div class="video-container">
                        <div class="video-preview" id="videoPreview">
                            <video id="previewVideo" autoplay muted playsinline></video>
                            <div class="video-overlay" id="videoOverlay">
                                <div class="overlay-content">
                                    <i class="fas fa-camera"></i>
                                    <h3>ุงุถุบุท ููุจุฏุก</h3>
                                    <p>ุงููุฑ ุนูู ุฒุฑ ุจุฏุก ุงูุชุตููุฑ ูุชูุนูู ุงููุงููุฑุง</p>
                                </div>
                            </div>
                        </div>

                        <div class="recording-controls">
                            <div class="camera-controls">
                                <button class="btn btn-outline" id="switchCameraBtn" style="display: none;">
                                    <i class="fas fa-sync-alt"></i>
                                    ุชุจุฏูู ุงููุงููุฑุง
                                </button>
                            </div>

                            <div class="main-controls">
                                <button class="btn btn-primary btn-large" id="startRecordingBtn">
                                    <i class="fas fa-record-vinyl"></i>
                                    ุจุฏุก ุงูุชุตููุฑ ูุงูุชุญููู
                                </button>
                                <button class="btn btn-danger btn-large" id="stopRecordingBtn" style="display: none;">
                                    <i class="fas fa-stop"></i>
                                    ุฅููุงู ูุฅููุงุก ุงูุชุญููู
                                </button>
                            </div>

                            <div class="recording-timer" id="recordingTimer" style="display: none;">
                                <i class="fas fa-circle"></i>
                                <span id="timerDisplay">00:00</span>
                                <span class="recording-text">ุฌุงุฑู ุงูุชุญููู ุงููุจุงุดุฑ...</span>
                            </div>
                        </div>

                        <div class="analysis-progress" id="analysisProgress" style="display: none;">
                            <div class="progress-header">
                                <i class="fas fa-chart-bar"></i>
                                <h4>ุฌุงุฑู ุงูุชุญููู ูู ุงูููุช ุงูุญูููู</h4>
                            </div>
                            <div class="progress-bars">
                                <div class="progress-item">
                                    <span class="progress-label">ูุนุงูุฌุฉ ุงูุฅุทุงุฑุงุช</span>
                                    <div class="progress-bar">
                                        <div class="progress-fill" id="processingProgress" style="width: 0%"></div>
                                    </div>
                                    <span class="progress-value" id="processingValue">0%</span>
                                </div>
                            </div>
                        </div>

                        <div class="live-indicators">
                            <div class="indicators-title">
                                <i class="fas fa-heartbeat"></i>
                                ุงููุคุดุฑุงุช ุงูุญูุฉ
                            </div>
                            <div class="indicators-grid" id="liveIndicators">
                                <div class="indicator-item">
                                    <div class="indicator-icon">
                                        <i class="fas fa-heartbeat"></i>
                                    </div>
                                    <div class="indicator-label">ุงูุญุงูุฉ ุงูุญุงููุฉ</div>
                                    <div class="indicator-value">ุฌุงุฑู ุงูุชููุฆุฉ</div>
                                </div>
                                <div class="indicator-item">
                                    <div class="indicator-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <div class="indicator-label">ุซูุฉ ุงูุชุญููู</div>
                                    <div class="indicator-value">0%</div>
                                </div>
                                <div class="indicator-item">
                                    <div class="indicator-icon">
                                        <i class="fas fa-film"></i>
                                    </div>
                                    <div class="indicator-label">ุงูุฅุทุงุฑุงุช ุงููุญููุฉ</div>
                                    <div class="indicator-value">0</div>
                                </div>
                                <div class="indicator-item">
                                    <div class="indicator-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="indicator-label">ูุฏุฉ ุงูุชุญููู</div>
                                    <div class="indicator-value">0s</div>
                                </div>
                            </div>
                        </div>

                        <div class="instructions-section">
                            <h4 class="instructions-title">
                                <i class="fas fa-lightbulb"></i>
                                ูุตุงุฆุญ ููุชุตููุฑ ุงููุซุงูู
                            </h4>
                            <ul class="instructions-list">
                                <li>
                                    <span class="bullet">โข</span>
                                    <span>ุชุฃูุฏ ูู ูุฌูุฏ ุฅุถุงุกุฉ ูุงููุฉ ููุงุถุญุฉ.</span>
                                </li>
                                <li>
                                    <span class="bullet">โข</span>
                                    <span>ุงุฌุนู ุงูุฏุฌุงุฌุฉ ูุงููุฉ ูู ุฅุทุงุฑ ุงูุชุตููุฑ.</span>
                                </li>
                                <li>
                                    <span class="bullet">โข</span>
                                    <span>ุตูุฑ ุงูุฏุฌุงุฌุฉ ููู ุชุชุญุฑู ูุชูููู ุงููุดู.</span>
                                </li>
                                <li>
                                    <span class="bullet">โข</span>
                                    <span>ูุฏุฉ ุงูุชุตููุฑ ุงูููุชุฑุญุฉ: 30-60 ุซุงููุฉ.</span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </section>

                <section class="results-section" id="resultsSection" style="display: none;">
                    <div class="results-header">
                        <div class="section-title">
                            <h2>ุงูุฎุทูุฉ 2: ุงูุชูุฑูุฑ ุงูุทุจู ุงูููุตู</h2>
                            <p>ูุชุงุฆุฌ ุงูุชุญููู ุจูุงุกู ุนูู ุงููุนุทูุงุช ูุงูุฐูุงุก ุงูุงุตุทูุงุนู</p>
                        </div>
                        <div class="results-actions">
                            <button class="btn btn-outline" onclick="window.print()">
                                <i class="fas fa-print"></i> ุทุจุงุนุฉ
                            </button>
                        </div>
                    </div>

                    <div class="confidence-indicator">
                        <div class="confidence-header">
                            <i class="fas fa-chart-line"></i>
                            <h3>ูุคุดุฑ ุงูุซูุฉ ุงูููู</h3>
                            <span class="confidence-value" id="overallConfidence">0%</span>
                        </div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="overallConfidenceBar" style="width: 0%;"></div>
                        </div>
                    </div>

                    <div class="overall-score-card">
                        <div class="score-header">
                            <i class="fas fa-chart-pie"></i>
                            <h3>ุงูุชูููู ุงูุนุงู ููุตุญุฉ ูุงูุญุฑูุฉ</h3>
                            <div class="total-score" id="totalScore">--%</div>
                        </div>
                        <div class="score-breakdown" id="scoreBreakdown">
                            <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                        </div>
                    </div>

                    <div class="detailed-analysis" id="detailedAnalysis">
                        <!-- ุณูุชู ููุคูุง ุฏููุงููููุงู -->
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-primary" id="newAnalysisBtn">
                            <i class="fas fa-redo"></i>
                            ุชุญููู ุฌุฏูุฏ
                        </button>
                    </div>
                </section>

                <section class="info-section" id="infoSection">
                    <h3 class="info-title"><i class="fas fa-info-circle"></i> ุชูููู ูุงู</h3>
                    <ul class="info-list">
                        <li><span class="bullet">โข</span> ูุฐุง ุงููุธุงู ูู ุฃุฏุงุฉ ูุณุงุนุฏุฉ ููุชุดุฎูุต ููุง ูุบูู ุนู ุงุณุชุดุงุฑุฉ ุงูุทุจูุจ ุงูุจูุทุฑู.</li>
                        <li><span class="bullet">โข</span> ุฏูุฉ ุงููุชุงุฆุฌ ุชุนุชูุฏ ุจุดูู ูุจูุฑ ุนูู ุฌูุฏุฉ ููุถูุญ ุงูุชุตููุฑ.</li>
                    </ul>
                </section>

            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p>ยฉ 2025 ุงูุนูุงุฏุฉ ุงูุจูุทุฑูุฉ ุงูุฐููุฉ - ุฌููุน ุงูุญููู ูุญููุธุฉ</p>
        </div>
    </footer>

    <!-- ูุงุนุฏุฉ ุงูุจูุงูุงุช (ูุฌุจ ุชุญููููุง ุฃููุงู) -->
    <script src="poultry-diseases-db.js"></script>
    
    <!-- ุงูููุฏ ุงูุฑุฆูุณู -->
    <script>
    // --- 1. ุฅุนุฏุงุฏุงุช ุงููููุฐุฌ ูุงููุงุฌูุฉ ---
    const MODEL_URL = "https://teachablemachine.withgoogle.com/models/etlPTgo5t/"; 
    let model, maxPredictions;
    let isAnalyzing = false;
    let stream = null;
    let videoElement = document.getElementById('previewVideo');
    let canvas = document.createElement('canvas');
    let ctx = canvas.getContext('2d');
    let animationFrameId;
    let startTime;
    let timerInterval;
    
    // ุนูุงุตุฑ ุงููุงุฌูุฉ
    const startBtn = document.getElementById('startRecordingBtn');
    const stopBtn = document.getElementById('stopRecordingBtn');
    const switchCameraBtn = document.getElementById('switchCameraBtn');
    const videoOverlay = document.getElementById('videoOverlay');
    const recordingTimer = document.getElementById('recordingTimer');
    const timerDisplay = document.getElementById('timerDisplay');
    const analysisProgress = document.getElementById('analysisProgress');
    const processingProgress = document.getElementById('processingProgress');
    const processingValue = document.getElementById('processingValue');
    const resultsSection = document.getElementById('resultsSection');
    const recordingSection = document.getElementById('recordingSection');
    const totalScoreEl = document.getElementById('totalScore');
    const scoreBreakdownEl = document.getElementById('scoreBreakdown');
    const detailedAnalysisEl = document.getElementById('detailedAnalysis');
    const newAnalysisBtn = document.getElementById('newAnalysisBtn');
    const overallConfidence = document.getElementById('overallConfidence');
    const overallConfidenceBar = document.getElementById('overallConfidenceBar');
    const liveIndicators = document.getElementById('liveIndicators');

    // ูุชุบูุฑุงุช ูุชุฎุฒูู ุงููุชุงุฆุฌ ุงูุชุฑุงูููุฉ
    let cumulativePredictions = {};
    let totalFramesAnalyzed = 0;
    let currentFacingMode = 'environment'; // ุงููุงููุฑุง ุงูุฎูููุฉ ุงูุชุฑุงุถูุงู
    let analysisStartTime = 0;

    // --- 2. ุชููุฆุฉ ุงููุธุงู ูุชุญููู ุงููููุฐุฌ ---
    async function init() {
        showToast('ุฌุงุฑู ุชุญููู ูููุฐุฌ ุงูุฐูุงุก ุงูุงุตุทูุงุนู...', 'info');
        startBtn.disabled = true;
        try {
            model = await tmImage.load(MODEL_URL + "model.json", MODEL_URL + "metadata.json");
            maxPredictions = model.getTotalClasses();
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-record-vinyl"></i> ุจุฏุก ุงูุชุตููุฑ ูุงูุชุญููู';
            showToast('ุชู ุชุญููู ุงููููุฐุฌ ุจูุฌุงุญ. ุฌุงูุฒ ููุชุตููุฑ!', 'success');
            
            // ุงูุชุญูู ูู ูุฌูุฏ ูุงููุฑุงุช ูุชุนุฏุฏุฉ
            const devices = await navigator.mediaDevices.enumerateDevices();
            const videoDevices = devices.filter(device => device.kind === 'videoinput');
            if (videoDevices.length > 1) {
                switchCameraBtn.style.display = 'inline-flex';
            }
            
        } catch (error) {
            console.error("ุฎุทุฃ ูู ุชุญููู ุงููููุฐุฌ:", error);
            showToast('ูุดู ุชุญููู ุงููููุฐุฌ. ุชุฃูุฏ ูู ุงูุฅูุชุฑูุช.', 'error');
            startBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ุฎุทุฃ ูู ุงูุชุญููู';
        }
    }

    // --- 3. ุงูุชุญูู ูู ุงููุงููุฑุง ูุงูุชุตููุฑ ---
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: currentFacingMode,
                    width: { ideal: 640 },
                    height: { ideal: 480 }
                }
            };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoElement.srcObject = stream;
            
            videoElement.onloadedmetadata = () => {
                videoOverlay.classList.add('hidden');
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-flex';
                recordingTimer.style.display = 'flex';
                analysisProgress.style.display = 'block';
                
                if (currentFacingMode === 'user') {
                    videoElement.classList.remove('rear-camera');
                } else {
                    videoElement.classList.add('rear-camera');
                }
                
                startAnalysis();
                startTimer();
            };
        } catch (err) {
            console.error("ุฎุทุฃ ูู ุงููุตูู ูููุงููุฑุง:", err);
            showToast('ุชุนุฐุฑ ุงููุตูู ูููุงููุฑุง. ูุฑุฌู ููุญ ุงูุตูุงุญูุงุช.', 'error');
        }
    }

    function stopCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            videoElement.srcObject = null;
        }
        videoOverlay.classList.remove('hidden');
        startBtn.style.display = 'inline-flex';
        stopBtn.style.display = 'none';
        recordingTimer.style.display = 'none';
        analysisProgress.style.display = 'none';
        stopTimer();
        stopAnalysis();
    }

    async function switchCamera() {
        stopCamera();
        currentFacingMode = currentFacingMode === 'environment' ? 'user' : 'environment';
        await startCamera();
    }

    // --- 4. ุงูุชุญููู ุงููุจุงุดุฑ (Real-time Analysis) ---
    function startAnalysis() {
        isAnalyzing = true;
        cumulativePredictions = {};
        totalFramesAnalyzed = 0;
        analysisStartTime = Date.now();
        canvas.width = videoElement.videoWidth || 640;
        canvas.height = videoElement.videoHeight || 480;
        
        analyzeFrameLoop();
    }

    function analyzeFrameLoop() {
        if (!isAnalyzing) return;

        ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        
        // ุชุญููู ุงูุฅุทุงุฑ
        model.predict(canvas).then(prediction => {
            let bestClass = null;
            let maxProb = 0;
            for (let i = 0; i < maxPredictions; i++) {
                if (prediction[i].probability > maxProb) {
                    maxProb = prediction[i].probability;
                    bestClass = prediction[i].className;
                }
            }

            if (maxProb > 0.6) { // ุซูุฉ > 60%
                cumulativePredictions[bestClass] = (cumulativePredictions[bestClass] || 0) + 1;
                totalFramesAnalyzed++;
                
                // ุชุญุฏูุซ ุดุฑูุท ุงูุชูุฏู
                const progress = (totalFramesAnalyzed % 100);
                processingProgress.style.width = `${progress}%`;
                processingValue.textContent = `ุฌุงุฑู ุงูุชุญููู... ${totalFramesAnalyzed} ุฅุทุงุฑ`;
                
                // ุชุญุฏูุซ ุงููุคุดุฑุงุช ุงูุญูุฉ
                updateLiveIndicators(bestClass, maxProb);
            }
        }).catch(error => {
            console.warn('ุฎุทุฃ ูู ุชุญููู ุงูุฅุทุงุฑ:', error);
        });

        // ุชุญููู 5 ุฅุทุงุฑุงุช ูู ุงูุซุงููุฉ ุชูุฑูุจุงู
        setTimeout(() => {
            animationFrameId = requestAnimationFrame(analyzeFrameLoop);
        }, 200);
    }
    
    function updateLiveIndicators(bestClass, confidence) {
        if (!liveIndicators) return;
        
        const confidencePercent = Math.round(confidence * 100);
        const elapsed = Math.round((Date.now() - analysisStartTime) / 1000);
        
        liveIndicators.innerHTML = `
            <div class="indicator-item">
                <div class="indicator-icon" style="background: ${confidence > 0.7 ? 'var(--gradient-success)' : 'var(--gradient-warning)'};">
                    <i class="fas fa-heartbeat"></i>
                </div>
                <div class="indicator-label">ุงูุญุงูุฉ ุงูุญุงููุฉ</div>
                <div class="indicator-value">${getDiseaseName(bestClass)}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-icon" style="background: var(--gradient-success);">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="indicator-label">ุซูุฉ ุงูุชุญููู</div>
                <div class="indicator-value">${confidencePercent}%</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-icon" style="background: var(--gradient-primary);">
                    <i class="fas fa-film"></i>
                </div>
                <div class="indicator-label">ุงูุฅุทุงุฑุงุช ุงููุญููุฉ</div>
                <div class="indicator-value">${totalFramesAnalyzed}</div>
            </div>
            <div class="indicator-item">
                <div class="indicator-icon" style="background: var(--gradient-secondary);">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="indicator-label">ูุฏุฉ ุงูุชุญููู</div>
                <div class="indicator-value">${elapsed}s</div>
            </div>
        `;
    }
    
    function getDiseaseName(diseaseCode) {
        if (!window.poultryDB) return diseaseCode;
        
        try {
            const info = window.poultryDB.getDiseaseInfo(diseaseCode);
            return info.name || diseaseCode;
        } catch (error) {
            return diseaseCode;
        }
    }

    function stopAnalysis() {
        isAnalyzing = false;
        
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
        
        finishAnalysis();
    }

    // --- 5. ุฅููุงุก ุงูุชุญููู ูุนุฑุถ ุงููุชุงุฆุฌ ---
    function finishAnalysis() {
        if (totalFramesAnalyzed === 0) {
            showToast('ูู ูุชู ุชุญููู ุฃู ุฅุทุงุฑุงุช. ุญุงูู ูุฑุฉ ุฃุฎุฑู.', 'warning');
            return;
        }

        displayResults();
    }

    // --- 6. ุนุฑุถ ุงููุชุงุฆุฌ (ุจุงุณุชุฎุฏุงู ูุงุนุฏุฉ ุงูุจูุงูุงุช) ---
    async function displayResults() {
        console.log('๐ ุนุฑุถ ุงููุชุงุฆุฌ...');
        
        // ุญุณุงุจ ุงููุชุงุฆุฌ ุงูููุงุฆูุฉ
        let winnerClass = "Healthy_Chicken";
        let maxVotes = 0;
        
        for (const [className, votes] of Object.entries(cumulativePredictions)) {
            if (votes > maxVotes) {
                maxVotes = votes;
                winnerClass = className;
            }
        }
        
        const confidence = Math.round((maxVotes / totalFramesAnalyzed) * 100);
        
        const result = {
            className: winnerClass,
            confidence: confidence,
            votes: maxVotes,
            totalFrames: totalFramesAnalyzed
        };
        
        console.log('๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ:', result);
        
        if (!result || result.totalFrames === 0) {
            showToast('ูู ูุชู ุชุญููู ุฃู ุฅุทุงุฑุงุช. ุญุงูู ูุฑุฉ ุฃุฎุฑู.', 'warning');
            return;
        }
        
        // ุฌูุจ ูุนูููุงุช ุงููุฑุถ ูุน ุชุญูู ุขูู
        let diseaseInfo;
        try {
            if (window.poultryDB && typeof window.poultryDB.getDiseaseInfo === 'function') {
                diseaseInfo = window.poultryDB.getDiseaseInfo(result.className);
                console.log('โ ูุนูููุงุช ุงููุฑุถ:', diseaseInfo);
            } else {
                throw new Error('ูุงุนุฏุฉ ุงูุจูุงูุงุช ุบูุฑ ูุชุงุญุฉ');
            }
        } catch (dbError) {
            console.warn('โ๏ธ ูุดู ุฌูุจ ูุนูููุงุช ุงููุฑุถ:', dbError);
            diseaseInfo = getFallbackDiseaseInfo(result.className);
        }
        
        const isHealthy = diseaseInfo.riskLevel === "ุขูู (Safe)";
        
        // ุฅุธูุงุฑ ูุณู ุงููุชุงุฆุฌ
        recordingSection.style.display = 'none';
        resultsSection.style.display = 'block';
        
        // ุชุญุฏูุซ ูุคุดุฑ ุงูุซูุฉ
        overallConfidence.textContent = `${result.confidence}%`;
        overallConfidenceBar.style.width = `${result.confidence}%`;
        
        // ุชุญุฏูุซ ุงููุชูุฌุฉ ุงูุฅุฌูุงููุฉ
        let scoreColor = isHealthy ? '#2e7d32' : '#c62828';
        totalScoreEl.textContent = `${result.confidence}%`;
        totalScoreEl.style.color = scoreColor;
        totalScoreEl.style.background = 'none';
        
        // ุชุญุฏูุซ ุชูุงุตูู ุงููุชูุฌุฉ
        scoreBreakdownEl.innerHTML = `
            <div class="score-item">
                <span class="score-label">ุงูุญุงูุฉ ุงููุดุฎุตุฉ</span>
                <div class="score-bar" style="background: ${scoreColor}20;">
                    <div class="score-fill animate" style="width: ${result.confidence}%; background: ${scoreColor};"></div>
                </div>
                <span class="score-value" style="color: ${scoreColor};">${result.confidence}%</span>
            </div>
            <div style="margin-top: 15px; font-size: 1.1rem; font-weight: bold; color: ${scoreColor}; text-align: center;">
                ${diseaseInfo.name}
            </div>
            <div style="margin-top: 10px; text-align: center; color: #666;">
                ุชู ุชุญููู ${result.totalFrames} ุฅุทุงุฑ ุฎูุงู ${Math.round((Date.now() - analysisStartTime) / 1000)} ุซุงููุฉ
            </div>
        `;
        
        // ุฅูุดุงุก ุงูุชุญููู ุงูุชูุตููู
        let detailsHtml = '';
        
        // ุจุทุงูุฉ ุงูุฃุนุฑุงุถ
        detailsHtml += `
            <div class="diagnosis-card active">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-binoculars"></i>
                        ุงูุฃุนุฑุงุถ ุงููุฑุตูุฏุฉ ุจุงูุญุฑูุฉ
                    </div>
                    <span class="toggle-icon">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </div>
                <div class="card-body">
                    <ul class="scientific-list">
                        ${diseaseInfo.symptoms.map(s => 
                            `<li>${s}</li>`
                        ).join('')}
                    </ul>
                    <div class="source-box">
                        <i class="fas fa-microscope"></i>
                        ูุตุฏุฑ ุงูุชุดุฎูุต: ุชุญููู ุญุฑูุฉ ูุณููู ุงูุฏุฌุงุฌ
                    </div>
                </div>
            </div>
        `;
        
        // ุจุทุงูุฉ ุงูุชูุตูุงุช
        if (!isHealthy) {
            detailsHtml += `
                <div class="diagnosis-card active">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-pills"></i>
                            ุงูุชูุตูุงุช ุงูุนูุงุฌูุฉ
                        </div>
                        <span class="toggle-icon">
                            <i class="fas fa-chevron-down"></i>
                        </span>
                    </div>
                    <div class="card-body">
                        <div class="treatment-section">
                            <div class="treatment-item">
                                <strong>ุงูุนูุงุฌ ุงูููุชุฑุญ:</strong>
                                ${Array.isArray(diseaseInfo.treatment) 
                                    ? `<ol class="scientific-list">
                                        ${diseaseInfo.treatment.map(t => `<li>${t}</li>`).join('')}
                                       </ol>`
                                    : `<p>${diseaseInfo.treatment}</p>`
                                }
                            </div>
                        </div>
                        <div class="emergency-level ${diseaseInfo.riskLevel.includes('ุฎุทูุฑ') ? 'ุนุงููุฉ' : 'ูุชูุณุทุฉ'}">
                            ูุณุชูู ุงูุงุณุชุนุฌุงู: ${diseaseInfo.riskLevel}
                        </div>
                    </div>
                </div>
            `;
        } else {
            detailsHtml += `
                <div class="diagnosis-card active">
                    <div class="card-header">
                        <div class="card-title">
                            <i class="fas fa-shield-alt"></i>
                            ุงูุญุงูุฉ ุงูุตุญูุฉ ุงูุนุงูุฉ
                        </div>
                        <span class="toggle-icon">
                            <i class="fas fa-chevron-down"></i>
                        </span>
                    </div>
                    <div class="card-body">
                        <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; border-right: 4px solid #2e7d32;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <i class="fas fa-check-circle" style="font-size: 2rem; color: #2e7d32;"></i>
                                <div>
                                    <h4 style="color: #2e7d32; margin: 0 0 5px 0;">ุญุงูุฉ ุตุญูุฉ ุฌูุฏุฉ</h4>
                                    <p style="color: #2e7d32; margin: 0;">ุงูุฏุฌุงุฌุฉ ุชุจุฏู ูู ุญุงูุฉ ุตุญูุฉ ุฌูุฏุฉ. ุงุณุชูุฑ ูู ุงูุฑุนุงูุฉ ุงูุฑูุชูููุฉ.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // ุฅุถุงูุฉ ุฅุญุตุงุฆูุงุช ุงูุชุญููู
        detailsHtml += `
            <div class="diagnosis-card active">
                <div class="card-header">
                    <div class="card-title">
                        <i class="fas fa-chart-line"></i>
                        ุฅุญุตุงุฆูุงุช ุงูุชุญููู
                    </div>
                    <span class="toggle-icon">
                        <i class="fas fa-chevron-down"></i>
                    </span>
                </div>
                <div class="card-body">
                    <div class="result-grid">
                        <div class="result-item">
                            <span class="result-label">ุนุฏุฏ ุงูุฅุทุงุฑุงุช ุงููุญููุฉ</span>
                            <span class="result-value">${result.totalFrames}</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ูุฏุฉ ุงูุชุญููู</span>
                            <span class="result-value">${Math.round((Date.now() - analysisStartTime) / 1000)} ุซุงููุฉ</span>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ูุณุจุฉ ุงูุซูุฉ</span>
                            <div class="confidence-indicator">
                                <div class="confidence-bar">
                                    <div class="confidence-fill" style="width: ${result.confidence}%;"></div>
                                </div>
                                <span class="confidence-percentage">${result.confidence}%</span>
                            </div>
                        </div>
                        <div class="result-item">
                            <span class="result-label">ุฃุนูู ุชุตููุช</span>
                            <span class="result-value">${result.votes}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        detailedAnalysisEl.innerHTML = detailsHtml;
        
        // ุชูุนูู ุงูุฃููุฑุฏููู
        attachAccordionListeners();
        
        // ุชูุฑูุฑ ุงูุณูุฑูู ููููุงูุฉ
        setTimeout(() => {
            resultsSection.scrollIntoView({ behavior: 'smooth' });
        }, 300);
    }

    // ุฏุงูุฉ fallback ูููุนูููุงุช ุงูุฃุณุงุณูุฉ
    function getFallbackDiseaseInfo(diseaseCode) {
        const fallbackDiseases = {
            "Healthy_Chicken": {
                name: "ุฏุฌุงุฌุฉ ุณูููุฉ",
                symptoms: ["ุญุฑูุฉ ุทุจูุนูุฉ", "ูุดู ูุชูุงุฒู", "ุณููู ูุดุท"],
                treatment: ["ุงูุงุณุชูุฑุงุฑ ูู ุงูุฑุนุงูุฉ ุงูุฑูุชูููุฉ"],
                riskLevel: "ุขูู (Safe)"
            },
            "Marek_Disease": {
                name: "ูุฑุถ ูุงุฑูู",
                symptoms: ["ุดูู ูู ุงูุฃุฑุฌู", "ูุดู ูุชุฑูุญ"],
                treatment: ["ุนุฒู ุงูุทููุฑ ุงููุตุงุจุฉ", "ุงุณุชุดุงุฑุฉ ุทุจูุจ ุจูุทุฑู"],
                riskLevel: "ุฎุทูุฑ (Dangerous)"
            },
            "Newcastle_Disease": {
                name: "ูุฑุถ ููููุงุณู",
                symptoms: ["ุตุนูุจุฉ ูู ุงูุชููุณ", "ุฅุณูุงู ุฃุฎุถุฑ"],
                treatment: ["ุชุทุนูู ุงูุทููุฑ", "ุนุฒู ุงููุทูุน"],
                riskLevel: "ุฎุทูุฑ ุฌุฏุงู (Critical)"
            },
            "Coccidiosis": {
                name: "ุงููููุณูุฏูุง",
                symptoms: ["ุฅุณูุงู ุฏููู", "ุฎููู ุนุงู"],
                treatment: ["ุนูุงุฌ ุทูููู", "ุชุญุณูู ุงููุธุงูุฉ"],
                riskLevel: "ูุชูุณุท (Moderate)"
            }
        };
        
        return fallbackDiseases[diseaseCode] || {
            name: diseaseCode,
            symptoms: ["ุฃุนุฑุงุถ ุบูุฑ ูุญุฏุฏุฉ"],
            treatment: ["ูุฑุฌู ุงุณุชุดุงุฑุฉ ูุชุฎุตุต"],
            riskLevel: "ุบูุฑ ูุนุฑูู"
        };
    }

    // --- ุฏูุงู ูุณุงุนุฏุฉ ---
    function attachAccordionListeners() {
        document.querySelectorAll('.diagnosis-card .card-header').forEach(header => {
            header.addEventListener('click', () => {
                const card = header.closest('.diagnosis-card');
                card.classList.toggle('active');
            });
        });
    }

    function startTimer() {
        startTime = Date.now();
        timerInterval = setInterval(() => {
            const elapsedTime = Date.now() - startTime;
            const seconds = Math.floor((elapsedTime / 1000) % 60).toString().padStart(2, '0');
            const minutes = Math.floor((elapsedTime / 1000 / 60)).toString().padStart(2, '0');
            timerDisplay.textContent = `${minutes}:${seconds}`;
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        timerDisplay.textContent = "00:00";
    }

    function showToast(message, type = 'info') {
        // ุฅูุดุงุก toast ุฌุฏูุฏ
        const toast = document.createElement('div');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            </div>
            <button class="toast-close"><i class="fas fa-times"></i></button>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => toast.classList.add('show'), 10);
        
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        }, 3000);
        
        toast.querySelector('.toast-close')?.addEventListener('click', () => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 300);
        });
    }

    // --- ุฑุจุท ุงูุฃุญุฏุงุซ ูุชุดุบูู ุงููุธุงู ---
    startBtn.addEventListener('click', startCamera);
    stopBtn.addEventListener('click', stopCamera);
    switchCameraBtn.addEventListener('click', switchCamera);
    newAnalysisBtn.addEventListener('click', () => location.reload());
    
    document.addEventListener('DOMContentLoaded', init);

    // (ุงุฎุชูุงุฑู) ูุธุงุฆู ุงูููุฏุฑ ูุงูุนุฏุงุฏุงุช ูู ุงูููุฏ ุงูุฃุตูู
    document.addEventListener('DOMContentLoaded', function() {
        const header = document.getElementById('mainHeader');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const mainNav = document.getElementById('mainNav');
        window.addEventListener('scroll', () => header.classList.toggle('scrolled', window.scrollY > 50));
        mobileMenuToggle?.addEventListener('click', () => {
            mobileMenuToggle.classList.toggle('active');
            mainNav.classList.toggle('active');
        });
        document.querySelectorAll('.stat-number').forEach(stat => {
            let start = 0; const target = parseInt(stat.getAttribute('data-count'));
            const timer = setInterval(() => {
                start += target / 50; if (start >= target) { stat.textContent = target; clearInterval(timer); } else { stat.textContent = Math.floor(start); }
            }, 40);
        });
        
        // ุชุญููู ูุญูู ุงูููุฏูู ุงููุญุณู
        const analyzerScript = document.createElement('script');
        analyzerScript.src = 'video-analyzer.js';
        analyzerScript.onload = () => {
            console.log('โ ุชู ุชุญููู ูุญูู ุงูููุฏูู ุงููุญุณู');
        };
        document.head.appendChild(analyzerScript);
    });
    </script>

   
</body>
</html>